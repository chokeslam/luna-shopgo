{"version":3,"sources":["product-cart.js"],"names":["System","register","_export","_context","async","sendAddAction","el","productId","dataset","id","Error","variantId","qtyInput","document","querySelector","quantity","Number","value","attachments","findAttachments","u","attachItems","idInput","attachment","checked","res","$http","post","product_id","variant_id","updateCartButton","data","count","trigger","dispatchEvent","detail","$cartButtons","querySelectorAll","$cartQuantity","$cartButton","classList","console","error","e","toCartPage","location","route","setters","_main","delegate","alert","message","swal","title","addToCart","currentTarget","buy"],"mappings":"AAAAA,OAAOC,SAAS,CAAC,UAAU,SAAUC,EAASC,GAiB9CC,eAAeC,EAAcC,GAC3B,MAAMC,EAAYD,EAAGE,QAAQC,GAE7B,IAAKF,EACH,MAAM,IAAIG,MAAM,iBAGlB,MAAMC,EAAYL,EAAGE,QAAQG,UAE7B,IAAKA,EACH,MAAM,IAAID,MAAM,iBAGlB,MAAME,EAAWC,SAASC,cAAc,wBAClCC,EAAWC,QAAOJ,aAAQ,EAARA,EAAUK,QAAS,GAE3CC,EA4FF,WAEA,MAAAA,EAASC,EAAeA,UAAG,0BACnBD,EAAcE,CAAC,EACrB,IAAA,MAAMC,KAAgBH,EAAA,CAEtB,MAAKI,EAAMC,EAAcL,cAAa,6BAC9BI,EAAUC,EAAWT,cAAc,mCACzCQ,EAAMV,UAENS,EAAYG,EAASP,OAAAD,OAAAJ,EAAAK,OA9CrB,CAiDF,OAAAI,CA/CA,CA1DAF,GACA,IAEA,MAAIM,QAAAL,EAAAM,MAAAC,KAAA,uBAAA,CACFC,WAAYrB,EAGRqB,WAAYrB,EACZsB,WACAd,gBAKJe,OA6CJ,SAAAC,GAEA,MAAAC,EAASF,EAAAA,OACPV,EAAAa,QAAMD,cAAmBD,EAAAC,GAEzBZ,SAASc,cAAc,IAAEH,YAAY,cAAA,CAErClB,OAASqB,CAELC,OACEJ,YAGJ,MACDK,EAAAvB,SAAAwB,iBAAA,2BAED,IAAA,MAAMD,KAAevB,EAASwB,CAE9B,MAAKC,EAAiBC,EAAIH,cAAc,6BACtCG,EAAMD,UAAgBC,OAAAA,cAAYzB,EAAc,GAEhDyB,EAAYC,YAAgBR,EAC5BM,EAAAA,cAAyB,IAAGN,YAAK,cAAA,CAEjCO,OAAAA,CAEIJ,OACEJ,WAzCN,CACF,CAnCID,CACDL,EAAAM,KAAAA,MAEDD,EAAAA,IAtBA,CAwBA,MAAOL,GAEPgB,MADAA,QAAQC,MAAEC,GACVF,CAvBA,CACF,CA2DF,SAAAG,IAEAC,SAASD,KAAAA,EAAUE,MAAG,OAjCpB,CAoFF,MAAA,CAACC,QAAA,CAAA,SAAAC,GAAA,GAAAD,QAAA,WA7ID3B,EAAA6B,SAAApC,SAAA,0BAAA,SAAA8B,KAsDAvC,eAAAE,GAEA,UACMD,EAAAC,EAxBF,CAyBA,MAAMD,GAENe,YADAA,EAAA8B,MAAQP,EAAEQ,QAAA,GAAA,UAvBV,OA0BFC,KAAA,CAEAC,MAAO,SACLA,QAAO,CAAA,OAAQ,WASjBT,GA7BA,CA5CFU,CAAAX,EAAAY,cAAA,IAEAnC,EAAA6B,SAAApC,SAAA,kBAAA,SAAA8B,KA0EAvC,eAAAE,GAEA,UACMD,EAAAC,EA/BF,CAgCA,MAAMD,GAENe,YADAA,EAAA8B,MAAQP,EAAEQ,QAAA,GAAA,UA9BV,CAiCFP,GA/BA,CAlDFY,CAAAb,EAAAY,cAAA,GAkGI,EAEJ","file":"product-cart.js","sourcesContent":["/**\n * Part of shopgo project.\n *\n * @copyright  Copyright (C) 2023 __ORGANIZATION__.\n * @license    __LICENSE__\n */\n\nimport '@main';\n\nu.delegate(document, '[data-task=add-to-cart]', 'click', (e) => {\n  addToCart(e.currentTarget);\n});\n\nu.delegate(document, '[data-task=buy]', 'click', (e) => {\n  buy(e.currentTarget);\n});\n\nasync function sendAddAction(el) {\n  const productId = el.dataset.id;\n\n  if (!productId) {\n    throw new Error('No product ID');\n  }\n\n  const variantId = el.dataset.variantId;\n\n  if (!variantId) {\n    throw new Error('No variant ID');\n  }\n\n  const qtyInput = document.querySelector('[data-role=quantity]');\n  const quantity = Number(qtyInput?.value || 1);\n\n  // Find additional purchases\n  const attachments = findAttachments();\n\n  try {\n    const res = await u.$http.post(\n      '@cart_ajax/addToCart',\n      {\n        product_id: productId,\n        variant_id: variantId,\n        quantity,\n        attachments\n      }\n    );\n\n    updateCartButton(res.data.data);\n\n    return res.data;\n  } catch (e) {\n    console.error(e);\n    throw e;\n  }\n}\n\nasync function addToCart(el) {\n  try {\n    await sendAddAction(el);\n  } catch (e) {\n    u.alert(e.message, '', 'warning');\n    return;\n  }\n\n  const v = await swal({\n    title: '已加入購物車',\n    buttons: [\n      '繼續購物',\n      '前往結帳'\n    ]\n  });\n\n  if (!v) {\n    return;\n  }\n\n  toCartPage();\n}\n\nasync function buy(el) {\n  try {\n    await sendAddAction(el);\n  } catch (e) {\n    u.alert(e.message, '', 'warning');\n    return;\n  }\n\n  toCartPage();\n}\n\nfunction toCartPage() {\n  location.href = u.route('cart');\n}\n\nfunction updateCartButton(data) {\n  const count = data.length;\n\n  u.trigger('cart.update', data, count);\n\n  document.dispatchEvent(\n    new CustomEvent('cart.update', {\n      detail: {\n        data,\n        count\n      }\n    })\n  );\n\n  const $cartButtons = document.querySelectorAll('[data-role=cart-button]');\n\n  for (const $cartButton of $cartButtons) {\n    const $cartQuantity = $cartButton.querySelector('[data-role=cart-quantity]');\n\n    $cartButton.classList.toggle('h-has-items', count > 0);\n    $cartQuantity.textContent = count;\n\n    $cartButton.dispatchEvent(\n      new CustomEvent('cart.update', {\n        detail: {\n          data,\n          count\n        }\n      })\n    );\n  }\n}\n\nfunction findAttachments() {\n  const attachments = u.selectAll('[data-role=attachment]');\n  const attachItems = {};\n\n  for (const attachment of attachments) {\n    const idInput = attachment.querySelector('[data-role=attachment_id]');\n    const qtyInput = attachment.querySelector('[data-role=attachment_quantity]');\n\n    if (idInput.checked) {\n      attachItems[idInput.value] = Number(qtyInput.value);\n    }\n  }\n\n  return attachItems;\n}\n"]}